# Lotsful AI Engine - 段階的情報蓄積型AI分析システム 要件定義書

## プロジェクト概要

企業の業務切り出しを支援し、副業/兼業人材との最適なマッチングを実現するAI分析システム。
**段階的情報蓄積アプローチ**により、各ステップでAI分析を行い、構造化テンプレートに情報を蓄積。
最終的に包括的な5タブ提案書を生成する営業支援ツール。

## 設計思想・開発原則

### システム思考の重視
**全体論的アプローチを基本とする設計方針**

#### 要素還元論ではなく全体論を重視
- ❌ **要素還元的思考**: 「技術的に可能なもの」を積み重ねる部分最適
- ✅ **システム思考**: 営業フロー全体における位置づけから機能を決定

#### 全体設計における重要な判断基準
1. **システム境界の明確化**: 「このシステムでやること vs 他でやること」の明確な線引き
2. **他システムとの関係性**: 営業フロー全体での役割と責任範囲の明確化
3. **本質的価値の追求**: 技術的可能性ではなく、ビジネス価値からの逆算設計
4. **運用現実性の重視**: 理想論ではなく、実際の営業現場での実用性を最優先

#### 具体的適用例
- **1次情報整理システム**: 提案書作成ではなく「情報の化石」整理に特化
- **足し算型データ統合**: AI掛け算分析ではなく、独立した情報の組み合わせ
- **段階的情報蓄積**: 一括処理ではなく、各ステップでの価値創出

### 技術的判断における全体最適
- **複雑性 vs 安定性**: 技術的に高度なソリューションより、運用安定性を重視
- **依存関係の最小化**: エラー波及を防ぐ独立性の確保
- **将来拡張性**: 部分的変更で全体が破綻しない柔軟な設計

### 外部指摘・提案への対応原則
**技術的指摘の妥当性検証プロセス**

#### 5つの検証ポイント
1. **要件定義との整合性**: 指摘が実際の機能要件と合致するか
2. **設計思想との一貫性**: システム思考に基づく全体設計と矛盾しないか  
3. **システム境界の理解**: 指摘者がシステムの責任範囲を正しく理解しているか
4. **優先度の妥当性**: 現在のフェーズで対応すべき課題か
5. **実装コストと価値**: 技術的改善のコストが生み出す価値に見合うか

#### 対応判断フロー
```
外部指摘 → 要件定義確認 → 設計思想との整合性 → 優先度評価 → 対応判断
```

#### 回避すべき判断パターン
- ❌ **技術的権威への盲従**: 「技術的に正しそう = 採用すべき」の錯覚
- ❌ **要素還元的対応**: 全体設計を無視した局所最適化
- ❌ **存在しない問題への対策**: 未実装・計画外機能への過度な心配

## システム構成

- **フロントエンド**: Next.js 15.3.3 + React 19 + TypeScript + Tailwind CSS
- **バックエンド**: Next.js API Routes (サーバーサイド処理)
- **AI**: Google Gemini 2.5 Flash Preview-05-20
- **データ**: セッションベース（データベース不要）
- **デプロイ**: Vercel + GitHub連携

## 機能要件

### 1. 新アーキテクチャ：段階的情報蓄積システム

#### コアコンセプト
**従来**: 一発型AI分析（ステップ3で全情報を一括処理）
**新**: 段階的蓄積型（各ステップでAI分析 → 構造化テンプレートに蓄積 → 最終統合分析）

#### 情報蓄積テンプレート構造
```
lotsful プロジェクト×人材マッチングシート

🏢 会社情報
企業名、業界、設立年、上場状況、従業員数、年商、所在地、事業内容、主要顧客層

🔍 事前リサーチ情報
企業情報メモ（ディープリサーチ結果）、最近の動き、組織特徴、仮説と洞察

📊 現状分析
事業フェーズ、課題カテゴリー、これまでの取り組み、チーム構成、不足スキル、外部人材経験

🎯 プロジェクト設計
解決したい課題、プロジェクトゴール、スコープ、フェーズ分け、稼働イメージ、予算

👤 人材イメージ
役割定義、必要スキル、人物像、カルチャーフィット

🤝 すり合わせ確認事項、💡 マッチング戦略、💭 商談メモ
```

#### 新4ステップフロー（2025年6月9日改訂）

**段階的テンプレート蓄積設計思想**
- **セクション独立性**: 各ステップは担当セクションのみを処理、他への影響なし
- **データ保護**: 既存データを保護しながら新規セクション追加（deepMerge活用）
- **責任分離**: Step1で現状分析を行わない等、各ステップの役割を明確化
- **エラー耐性**: 1ステップの失敗が全体に波及しない、デバッグ容易
- **段階的品質向上**: 各ステップで専門性特化、最終的な情報精度向上
- **開発安定性**: セクション単位での独立開発・テスト・デバッグが可能

1. **ステップ1: ディープリサーチ入力**【事前情報のみ】
   - リサーチ結果テキスト入力
   - **AI分析ボタン** → 🏢 **会社情報** + 🔍 **事前リサーチ情報** のみ抽出・蓄積
   - 業界自動判定・抽出
   - **処理対象**: `companyProfile` + `researchData` セクションのみ
   - **非処理領域**: 現状分析、プロジェクト設計等（Step2以降の役割）

2. **ステップ2: 課題・追加情報入力**【分析・設計情報追加】
   - **📝 自由記述・AI自動入力**: 商談議事録等の自由テキストからAI抽出
   - **テンプレート直接編集機能**: 各セクションの手動編集
   - **AI分析ボタン**: 自由記述テキスト → 📊 **現状分析** + 🎯 **プロジェクト設計** を追加蓄積
   - **処理対象**: `currentAnalysis` + `projectDesign` セクション追加
   - **既存保護**: Step1で入力された会社情報・リサーチ情報は保持
   - **UI簡素化**: 冗長な「情報補完」ボタンを削除、自由記述からのAI分析に一本化

3. **ステップ3: 業務選択**【選択情報記録】
   - 業界自動連携済み（Step1結果を活用）
   - 7×4マトリックスで業務選択
   - **処理対象**: 選択内容を `metadata.selectedBusinessItems` に保存
   - **既存保護**: Step1-2で蓄積された全情報は保持

4. **ステップ4: テンプレートデータ統合・確認**【全体統合・品質確保】
   - Step1-3で蓄積された**全セクション**の視覚的表示
   - 不足情報の確認・追加入力機能
   - データ修正・編集機能
   - 分析データの透明性確保
   - 1次情報PDF出力機能
   - **最終AI分析ボタン** → テンプレート全体から**5タブ提案書完全生成**

**5タブ提案書生成設計**
- **一括AI生成**: Tab1-3（課題整理、プロジェクト設計、人材提案）
- **手動生成**: Tab4-5（期待成果、実施要項）は後日実装予定
- **実装優先度**: Phase1でTab1-3完成、Phase2でTab4-5追加

### 2. 継続機能
- 7×4業務マトリックス（7カテゴリ × 4フェーズ）
- Gemini API統合
- AI Honesty機能（情報不足時は「情報不足により特定不可」表示）

### 3. 新機能：Step4テンプレートデータ統合・確認システム

#### データ統合・可視化機能
**目的**: AI分析前の情報確認と透明性確保
```
📊 テンプレートデータ統合・確認

┌─ 企業基本情報 ────────────────┐
│ [企業名]（[従業員数]）              │ ✏️編集
│ [業界1] × [業界2] × [業界3]       │
│ 年商：[売上規模] / 本社：[所在地]     │
└──────────────────────────┘

┌─ プロジェクト概要 ────────────────┐
│ 課題：[課題カテゴリ1], [課題カテゴリ2]  │ ✏️編集
│ 予算：月[XX]万円 × [期間]ヶ月        │
│ 稼働：[XX]時間/月                 │
│ 緊急性：[緊急度の理由]              │
└──────────────────────────┘

┌─ 選択された業務項目 ─────────────────┐
│ • [カテゴリ1] / [フェーズ1]: [業務内容1] │
│ • [カテゴリ2] / [フェーズ2]: [業務内容2] │
│ • [カテゴリ3] / [フェーズ3]: [業務内容3] │
└──────────────────────────────┘

┌─ 現状分析詳細 ──────────────────┐
│ 事業フェーズ：[フェーズ]              │ ✏️編集
│ これまでの取り組み：[過去の施策]       │
│ 失敗理由：[課題となった要因]          │
│ チーム構成：[部署] [人数]名 他         │
└──────────────────────────┘

⚠️ 不足情報チェック
❌ チーム構成の詳細が不足
❌ 予算の詳細設定が必要
✅ 企業情報は十分
✅ 課題分析は完了

📈 分析品質スコア: 85/100

[📝 不足情報追加] [🔄 データ修正] [🚀 AI総合分析開始]
```

#### データ品質チェック機能
- **必須項目確認**: 企業名、業界、課題、予算等の入力状況
- **整合性チェック**: 予算と稼働時間、課題と選択業務の適合性
- **分析品質スコア**: データ充実度の数値化（0-100点）
- **不足情報アラート**: 精度向上に必要な追加情報の提示

#### 編集・修正機能
- **インライン編集**: 各セクションをその場で修正可能
- **項目追加**: 不足している情報を直接追加
- **データ検証**: 修正内容の整合性自動チェック
- **保存状態管理**: 変更の自動保存と未保存状態の表示

#### 1次情報PDF出力機能【新機能】
**目的**: システム非依存の1次データ化と外部ツール連携

**PDF構成**:
```
📄 Lotsful 1次情報統合レポート
生成日時: [YYYY年MM月DD日 HH:MM]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏢 企業基本情報
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
企業名: [企業名]
業界: [業界1] × [業界2] × [業界3]
従業員数: [規模] / 年商: [売上規模]
本社: [所在地]
事業内容: [詳細説明]
主要顧客: [顧客層]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 事前リサーチ情報
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ディープリサーチ: [Step1で入力された情報]
最近の動き: [ニュース・プレスリリース等]
組織特徴: [企業文化・組織の特徴]
仮説・洞察: [分析者の仮説]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 現状分析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
事業フェーズ: [startup/growth/expansion/mature]
課題カテゴリ: [課題1], [課題2], [課題3]
これまでの取り組み: [過去の施策詳細]
失敗理由: [課題となった要因]
チーム構成: [部署名] [人数]名, [部署名] [人数]名
不足スキル: [スキル1], [スキル2], [スキル3]
外部人材経験: [none/contractor/consultant等]
意思決定プロセス: [immediate/manager_approval等]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 プロジェクト設計
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
解決したい課題: [課題要約]
緊急性の理由: [なぜ今なのか]
3ヶ月後の理想状態: [達成したい状態]
予算: 月[XX]万円 × [期間]ヶ月 = 総額[XXX]万円
稼働時間: [XX]時間/月 ([light_10h/standard_20h/commit_30h])
期待成果物: [成果物1], [成果物2], [成果物3]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔧 選択業務項目
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• [カテゴリ1] / [フェーズ1]: [業務内容1]
• [カテゴリ2] / [フェーズ2]: [業務内容2]  
• [カテゴリ3] / [フェーズ3]: [業務内容3]
（選択項目数: [N]項目）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📈 データ品質・生成情報
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析品質スコア: [XX]/100
完了ステップ: Step1 ✅ / Step2 ✅ / Step3 ✅
生成システム: Lotsful AI Engine v[バージョン]
データソース: Step1-3累積テンプレートデータ
最終更新: [YYYY-MM-DD HH:MM:SS]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 活用ガイド
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
※このPDFは「1次情報」です。
　以下の用途でご活用ください：

1. 外部AIツール分析: Claude、ChatGPT等に入力
2. 社内共有: 関係者への情報共有資料
3. 提案書作成: 他システムでの2次加工素材
4. バックアップ: システム非依存の情報保存
5. 顧客説明: 分析プロセスの透明性確保
```

**活用価値**:
- **システム非依存**: PDFがあれば他ツールでも分析可能
- **外部AI連携**: Claude、ChatGPT等への入力データとして活用
- **情報永続化**: セッション終了後も情報が保持される
- **営業支援**: 社内共有・顧客説明資料として直接活用
- **品質担保**: 分析データの透明性と再現性を確保

**技術仕様**:
- **PDF生成ライブラリ**: jsPDF または react-pdf
- **ファイル名**: `lotsful_[企業名]_[YYYYMMDD_HHMM].pdf`
- **文字エンコーディング**: UTF-8対応（日本語フォント埋め込み）
- **ページサイズ**: A4縦向き
- **出力トリガー**: Step4画面の「📄 PDF出力」ボタン

### 4. 新機能：5タブ提案書システム

#### 5タブ生成方式・実装計画

**Phase 1実装（優先度：高）**
- **Tab 1-3: 一括AI自動生成**（Step4の最終AI分析で実行）
- **Tab 4-5: UI構造準備**（「Coming Soon」表示、手動生成ボタン配置）

**Phase 2実装（優先度：中）**  
- **Tab 4-5: 手動生成API実装**（個別ボタンでAPI連携）

#### Tab 1-3: 一括AI自動生成仕様

**Tab 1: 課題整理（AI自動生成）**
```
現状分析
企業名：[会社名]
業界：[業界]
従業員数：[規模]

課題マッピング
| 領域 | 現状 | 理想 | ギャップ |
|------|------|------|---------|
| [領域1] | [現状詳細] | [理想詳細] | [ギャップ分析] |
| [領域2] | [現状詳細] | [理想詳細] | [ギャップ分析] |
| [領域3] | [現状詳細] | [理想詳細] | [ギャップ分析] |

課題の深掘り
表面的な課題
[表面的に見えている問題]

本質的な課題
[真の原因・構造的な問題]

放置した場合の影響
- 短期（3ヶ月）: [具体的なリスク]
- 中期（6ヶ月）: [具体的なリスク]
- 長期（1年）: [具体的なリスク]
```

**Tab 2: プロジェクト設計（自動生成）**
```
プロジェクト概要
ミッション
[プロジェクトで実現すること]

スコープ定義
含むもの
✅ [スコープ1]
✅ [スコープ2]
✅ [スコープ3]

含まないもの
❌ [対象外1]
❌ [対象外2]

フェーズ設計
Phase 1: [フェーズ名]（[期間]）
目的: [このフェーズのゴール]

主要タスク
- [タスク1]
  詳細：[具体的な作業内容]
  期限：[日数/週数]
- [タスク2]
  詳細：[具体的な作業内容]
  期限：[日数/週数]

成果物
📄 [成果物1]
📊 [成果物2]
🔧 [成果物3]

マイルストーン: [具体的な達成基準]

Phase 2: [フェーズ名]（[期間]）
目的: [このフェーズのゴール]

主要タスク
- [タスク1]
  詳細：[具体的な作業内容]
  期限：[日数/週数]
- [タスク2]
  詳細：[具体的な作業内容]
  期限：[日数/週数]

成果物
📈 [成果物1]
🚀 [成果物2]

マイルストーン: [具体的な達成基準]
```

**Tab 3: 人材提案（AI自動生成）**
- **生成方式**: Tab1-2と同時に一括AI生成
- **内容**: 人材要件定義、人材タイプ提案、稼働条件
  - 求める人材像・必要スキルセット・経験レベル
  - 想定工数（テンプレートの稼働時間設定を活用）
  - リモートワーク前提・コミュニケーション頻度

#### Tab 4-5: 手動生成準備仕様（Phase 2実装予定）

**Tab 4: 期待成果（手動生成ボタン）**【Phase 2実装】
- **現在**: 「Coming Soon」表示 + 手動生成ボタン（無効化）
- **将来**: 個別API連携による生成
- **内容**: 
  - 定量的成果（ROI計算、コスト削減効果、効率向上指標）
  - 定性的成果（組織能力向上、プロセス改善、競争力強化）
  - 時系列効果（短期・中期・長期成果）

**Tab 5: 実施要項（手動生成ボタン）**【Phase 2実装】
- **現在**: 「Coming Soon」表示 + 手動生成ボタン（無効化）
- **将来**: 個別API連携による生成
- **内容**:
  - 契約形態（準委任契約、成果物ベース契約、時間ベース契約）
  - 費用構造（時間単価設定、成果物単価、支払い条件）
  - 実施体制（プロジェクト体制図、役割分担、報告ライン）

## 技術要件

### データ構造設計

#### 段階的蓄積テンプレート構造
```javascript
{
  // 会社情報
  companyProfile: {
    name: string,
    industry: string[],
    establishedYear: number,
    isPublic: boolean,
    marketListing: string,
    employeeCount: string,
    revenue: string,
    headquarters: string,
    offices: string[],
    businessDescription: string,
    mainCustomers: string
  },
  
  // 事前リサーチ情報
  researchData: {
    deepResearchMemo: string,
    recentNews: string,
    organizationCulture: string,
    hypothesisInsights: string,
    meetingCheckpoints: string[]
  },
  
  // 現状分析
  currentAnalysis: {
    businessPhase: string,
    challengeCategories: string[],
    previousEfforts: string,
    failureReasons: string,
    teamComposition: object[],
    missingSkills: string[],
    externalTalentExperience: string,
    freelanceReadiness: string,
    competitorAnalysis: string,
    decisionProcess: string
  },
  
  // プロジェクト設計
  projectDesign: {
    challengeSummary: string,
    urgencyReason: string,
    risksIfIgnored: string,
    idealState3Months: string,
    successMetrics: object,
    deliverables: string[],
    scope: { included: string[], excluded: string[] },
    phases: object[],
    workingHours: string,
    budget: object
  },
  
  // 人材イメージ
  talentRequirements: {
    expectedRole: string[],
    engagementType: string[],
    requiredSkills: string[],
    preferredSkills: string[],
    industryExperience: object,
    personalityType: string[],
    mindset: string[],
    cultureFit: string
  },
  
  // メタデータ
  metadata: {
    step1Completed: boolean,
    step2Completed: boolean,
    step3Completed: boolean,
    selectedBusinessItems: object[],
    analysisHistory: object[]
  }
}
```

### AI分析エンジン拡張

#### ステップ1: 企業リサーチ分析【事前情報特化】
```
入力: リサーチテキスト
出力: 企業基本情報 + 事前リサーチ情報 → テンプレート該当セクション蓄積
分析内容: 企業名、業界、規模、事業内容、組織特徴、最近の動き等の抽出
処理対象: companyProfile + researchData セクションのみ
非処理領域: 現状分析、プロジェクト設計、人材要件等（責任分離）
```

#### ステップ2: 課題・追加情報分析【分析・設計特化】
```
入力: 課題情報 + 既存テンプレート（Step1結果活用）
出力: 現状分析 + プロジェクト設計 → テンプレート該当セクション追加蓄積
分析内容: 課題分類、チーム構成、プロジェクト設計、成果物定義等
処理対象: currentAnalysis + projectDesign セクション追加
既存保護: Step1で蓄積された企業情報・リサーチ情報は完全保持
```

#### ステップ3: 業務選択
```
入力: 既存テンプレート + 業界情報
出力: 選択業務項目 → テンプレート保存
分析内容: 業務選択状況の記録
```

#### ステップ4: テンプレートデータ統合・確認
```
入力: 完全蓄積テンプレート + 選択業務項目
出力: データ品質スコア + 不足情報リスト
分析内容: データ整合性チェック、品質評価
```

#### ステップ5: 最終統合分析（旧ステップ3）
```
入力: 確認済み完全テンプレート + 選択業務項目
出力: 5タブ提案書
分析内容: 包括的プロジェクト提案生成
```

#### AI Honesty強化プロンプト
```
【重要指示】
- テンプレートに情報がない項目は「情報不足により特定不可」
- 推測や創作は禁止
- 段階的な情報収集の必要性を明示
- 営業現場での実用性を重視
```

### UI/UX設計

#### タブナビゲーション
- 5タブの横スクロール対応
- アクティブタブの視覚的強調
- 生成状態の表示（自動/手動/未生成）

#### 生成ボタン配置
- Tab3-5各タブ内に「AI分析で生成」ボタン
- 生成中のローディング表示
- 生成エラー時の再試行機能

### APIエンドポイント設計

#### 新規API（段階的分析対応）
- `/api/analyze-step1`: 企業リサーチ分析 → テンプレート基本情報蓄積
- `/api/analyze-step2`: 課題・追加情報分析 → テンプレート追加蓄積
- `/api/template-validate`: テンプレートデータ品質チェック → 品質スコア・不足情報
- `/api/analyze-final`: 最終統合分析 → 5タブ提案書生成（旧analyze-step3）

#### 既存API拡張
- `/api/analyze`: 既存の一括分析（後方互換）

#### 新規API（手動生成）
- `/api/generate-talent`: Tab3人材提案生成
- `/api/generate-outcome`: Tab4期待成果生成
- `/api/generate-implementation`: Tab5実施要項生成

#### テンプレート管理API
- `/api/template/save`: テンプレート保存
- `/api/template/load`: テンプレート読み込み
- `/api/template/update`: テンプレート部分更新

## 実装計画

### フェーズ1（完了済み）：段階的蓄積システム基盤
1. **テンプレート構造設計・実装** ✅
2. **ステップ1のAI分析機能追加** ✅
3. **ステップ2のテンプレート編集機能** ✅
4. **ステップ3の業務選択機能** ✅

### フェーズ2（現在実装中）：5タブシステム基盤
1. **Step4: テンプレートデータ統合・確認システム**【実装予定】
   - データ統合・可視化UI
   - データ品質チェック機能
   - インライン編集機能
   - 1次情報PDF出力機能
   - `/api/template-validate` 実装

2. **5タブ提案書システム完成**【実装予定】
   - **Tab1-3**: 一括AI自動生成（既存analyze-step3 APIを活用）
   - **Tab4-5**: UI構造準備（「Coming Soon」表示）
   - 5タブナビゲーション・表示システム完成

### フェーズ3（今後予定）：PDF・個別生成システム
1. **1次情報PDF出力システム**
   - PDF生成ライブラリ導入（jsPDF or react-pdf）
   - 日本語フォント対応
   - ダウンロード機能実装
   
2. **Tab4-5個別生成API実装**
   - `/api/generate-outcome`: Tab4期待成果生成
   - `/api/generate-implementation`: Tab5実施要項生成
   - 手動生成ボタンの有効化

## 制約事項

- **副業/兼業制約**: リモート中心、月10-80時間（選択可能、デフォルト30時間）、準委任契約
- **AI精度**: 100%正確性不要、営業支援ツールとして十分な品質
- **データ保持**: セッションベース、永続化不要（営業支援用途）
- **対象業界**: 40+業界対応
- **対象業務**: 7カテゴリ×4フェーズ=28分野
- **段階的構築**: 既存システムとの後方互換性維持

## 成功指標

- **段階的蓄積**: 各ステップでテンプレート情報が正確に蓄積される
- **AI分析品質**: 各段階で適切な情報抽出・構造化が行われる
- **ユーザビリティ**: 営業現場で直感的に使える操作性
- **提案品質**: 実際の商談で活用可能なレベルの提案書生成
- **システム安定性**: 段階的分析でのエラー発生時の適切なフォールバック

## 補足事項

- **AI Honesty機能**: 情報不足時の正直な回答（「情報不足により特定不可」）
- **Gemini 2.5 Flash Preview-05-20**: 継続使用
- **段階的リリース**: テンプレート基盤 → ステップ分析 → 5タブ完成
- **既存機能**: 現在の一括分析システムも並行維持

## 開発状況（2025年6月9日現在）

### ✅ フェーズ1完了：段階的情報蓄積システム基盤（2025年6月8日）

#### 🏗️ テンプレート基盤システム
- **TypeScript型定義** (`src/types/template.ts`)
  - 完全な構造化テンプレート定義（CompanyProfile, ResearchData, CurrentAnalysis, ProjectDesign等）
  - 各ステップでの更新対象セクション明確化
  - 初期化関数とバリデーション機能

- **テンプレート管理システム** (`src/utils/templateManager.ts`)
  - セッションストレージでの永続化機能
  - ステップごとの部分更新機能（updateStep1, updateStep2, updateStep3）
  - 深いマージとエラーハンドリング
  - React Hook対応（useTemplate）

#### 🧠 Step1: ディープリサーチ入力・AI分析
- **Step1専用API** (`src/app/api/analyze-step1/route.js`)
  - 企業リサーチテキスト → 構造化データ変換
  - Gemini 2.5 Flash Preview-05-20連携
  - AI Honesty機能（情報不足時は「情報不足により特定不可」）
  - 企業名、業界、従業員数、事業内容等の自動抽出

- **UI拡張** (`src/components/CompanyInfo/CompanyInfoInput.jsx`)
  - AI分析ボタン追加
  - テンプレート自動保存・読み込み
  - 業界自動連携機能
  - 抽出結果の視覚的表示

#### 📝 Step2: テンプレート統合編集・AI補完
- **TemplateEditor UI** (`src/components/TemplateEditor/TemplateEditor.jsx`)
  - 📝 **自由記述・AI自動入力セクション**: 商談議事録等から構造化データに自動変換
  - 🏢 会社情報セクション（Step1結果 + 手動編集）
  - 🔍 リサーチデータセクション（展開・編集可能）
  - 📊 現状分析セクション（新規入力 + AI補完）
  - 🎯 プロジェクト設計セクション（新規入力 + AI補完）
  - セクション展開/折りたたみ、配列項目管理
  - リアルタイム保存・未保存状態表示

- **Step2専用API** (`src/app/api/analyze-step2/route.js`)
  - **自由記述テキスト処理**: 商談議事録・ヒアリング内容をfreeTextパラメータで受信
  - 既存テンプレート情報を活用した補完分析
  - 現状分析とプロジェクト設計の深掘り
  - AI Honesty機能継続
  - 副業/兼業制約を考慮した現実的提案
  - **エラーハンドリング強化**: request.json()重複読み込み問題解決済み

#### 🔄 システム統合
- **ThreeStepFlow統合** (`src/components/ThreeStepFlow/ThreeStepFlow.jsx`)
  - Step2でTemplateEditorを使用
  - テンプレート更新時の業界自動連携
  - 段階的データ蓄積フローの完成
  - 後方互換性維持

#### 🎯 実現した機能フロー
1. **Step1**: リサーチ入力 → AI分析 → 企業情報テンプレート蓄積 ✅
2. **Step2**: 全テンプレート編集 → AI分析 → 深掘り情報補完 ✅
3. **Step3**: 業務選択・人数設定 → Step4に進む ✅
4. **Step4**: データ統合確認 → 最終AI分析 → 5タブ提案書生成 ✅

### ✅ フェーズ2完了：4ステップフロー・Step4統合確認システム（2025年6月9日）

#### 🔧 Step3: 業務選択システム強化
- **人数選択機能** (`src/components/BusinessMatrix/BusinessMatrix.jsx`)
  - 1-5名の希望人数選択ドロップダウン
  - 複数人選択時の工数分担表示（例：「2名で40時間の場合：1名20時間ずつ」）
  - 稼働時間範囲拡張（20-40時間 → 10-80時間、5時間刻み）

- **Step3完了処理の変更**
  - AI分析をStep4に移動
  - 業務選択のみに役割特化
  - テンプレートに人数・稼働時間を保存してStep4に進む流れ

#### 🎯 Step4: テンプレートデータ統合・確認システム
- **TemplateIntegration UI** (`src/components/TemplateIntegration/TemplateIntegration.jsx`)
  - **分析精度スコアシステム**: 0-100点での精度評価（最大177点の重み付け）
  - **重要度別データ表示**: 🔴超重要・🟡重要・🟢中程度・🔵補助的の4カテゴリ分類
  - **推奨入力機能**: 不足情報を重要度順でアラート、影響度説明付き
  - **インライン編集機能**: 各セクションの展開・編集・保存機能
  - **データ品質チェック**: 企業名・課題・業務選択等の必須項目確認

#### 🤖 最終統合分析API・5タブ生成システム
- **最終統合分析API** (`src/app/api/analyze-final/route.js`)
  - 完全なテンプレート統合分析（Step1-4の全情報活用）
  - **Tab1-3自動生成**: 課題整理・プロジェクト設計・人材提案の一括AI生成
  - **Tab4-5準備**: 期待成果・実施要項（Coming Soon表示、手動生成ボタン配置）
  - AI Honesty機能継続、副業/兼業制約考慮
  - 重要度情報を活用した高精度プロンプト生成

#### 📊 分析精度スコアシステム詳細
**コンセプト**: AI分析精度向上のための重要度指標システム

**重要度分類** (合計177点):
- 🔴 **超重要(15-20点)**: 選択業務項目(20)、企業名(15)、課題カテゴリ(15)
- 🟡 **重要(8-12点)**: ディープリサーチ(12)、稼働時間(12)、希望人数(10)、業界(10)
- 🟢 **中程度(5-7点)**: 緊急性理由(7)、失敗理由(6)、理想状態(6)、不足スキル(6)
- 🔵 **補助的(2-4点)**: 事業内容(4)、予算(4)、従業員数(3)、年商(3)

**UI機能**:
- リアルタイム精度スコア表示（0-100点）
- 重要度順の推奨入力アラート（+XX点、影響度説明付き）
- カテゴリ別色分け表示とアイコン
- 分析実行可能閾値の表示（50点以上で実行、70点以上で高精度）

**設計資料**: `ANALYSIS_WEIGHTS.md`で全項目詳細を文書化

#### 🔄 4ステップフロー統合
- **ThreeStepFlow → FourStepFlow** (`src/components/ThreeStepFlow/ThreeStepFlow.jsx`)
  - ステップインジケーターを4段階に拡張
  - Step3完了 → Step4への自動遷移
  - Step4でのTemplateIntegration表示と最終AI分析実行
  - 適切なナビゲーション・進捗表示・エラーハンドリング

### 🔄 実装予定（次回開発時）

#### 高優先度タスク

##### 1. AI分析精度向上システム
**分析精度スコアをAI分析APIで活用し、実際の分析精度を向上**
- `/api/analyze-final`での重要度プロンプト強化
- 超重要項目（20点）を最上位で強調
- 重要項目（8-12点）を詳細分析対象として明記
- 欠損情報の影響度をAIに伝達

##### 2. 1次情報統合PDF出力システム
**Step4でのPDF出力機能実装**
- react-pdf or jsPDFでの日本語対応PDF生成
- テンプレート全情報の構造化出力
- 外部AI（Claude、ChatGPT）連携用フォーマット
- ファイル名: `lotsful_[企業名]_[YYYYMMDD_HHMM].pdf`

#### 中優先度タスク

##### 3. Tab4-5手動生成API実装
**期待成果・実施要項の個別生成機能**
- `/api/generate-outcome`: Tab4期待成果生成
- `/api/generate-implementation`: Tab5実施要項生成  
- ProposalTabs UI での手動生成ボタン有効化

##### 4. Step4 UI機能強化
**テンプレート統合確認画面の詳細機能**
- より充実したインライン編集機能
- セクション別の編集履歴表示
- 分析精度向上のための具体的入力支援

#### 低優先度タスク

##### 5. 分析精度スコア拡張
**業界別・フェーズ別重要度調整**
- 業界特性に応じた重み付け変更
- プロジェクトフェーズによる重要度調整
- 実分析結果による重要度チューニング

##### 6. システム連携・エクスポート機能
**他システムとの連携強化**
- **AI分析データソース統一**: 全Step3分析はベーステンプレート（Step1+2）から実行
- **独立性保証**: 各分析が独立、エラー波及なし、デバッグ容易
- **PDF生成**: react-pdf等でテンプレートデータ + 分析結果を統合レイアウト
- **運用フロー**: システム内で1次情報整理 → PDF出力 → 他システムで提案書作成

**設計判断の根拠**:
- **累積分析 vs ベース分析**: 累積分析（Step3結果を次の分析に使用）は技術的に可能だが、AIトークン制限・依存関係複雑化・エラー波及リスクを考慮してベーステンプレート統一を採用
- **PDF用途の明確化**: 提案書作成ではなく「1次情報（化石）」の整理・出力に特化。加工は他システムで実施
- **情報量 vs 精度**: 1次情報は情報量重視、後の加工で様々な提案書パターンに対応可能

**実装優先度**: Step3完成後（中優先度）

#### 将来拡張（優先度：低）
- Tab3-5の手動生成API実装
- テンプレートエクスポート/インポート機能
- 分析履歴の詳細表示
- 人材マッチング機能（遠い将来の構想）

### 📊 現在のアーキテクチャ状況
```
完成: Step1 ✅ → Step2 ✅ → Step3 ✅ → Step4 ✅ → 5タブ提案書 ✅
基盤: テンプレート管理 ✅ + AI分析エンジン ✅ + 分析精度スコア ✅ + 4ステップUI ✅
```

### 🛠️ 技術的成果
- **4ステップ段階的情報蓄積**による高精度分析の実現
- **分析精度スコアシステム**によるAI分析品質向上
- **重要度別データ処理**による効率的な情報管理
- **AI Honesty機能**による信頼性の確保
- **セッションベース**の軽量データ管理
- **型安全**なテンプレート操作
- **既存システム**との共存（後方互換性）

### 📝 次回開発時の開始ポイント
1. **AI分析精度向上**: `/api/analyze-final`での重要度プロンプト強化
2. **PDF出力機能**: Step4でのreact-pdf実装
3. **Tab4-5手動生成**: 期待成果・実施要項の個別API実装
4. **分析精度スコア拡張**: 業界別・フェーズ別調整

### 🔧 開発環境・リポジトリ情報
- **Repository**: https://github.com/sassan0808/lotsful-ai-engine-.git
- **Branch**: main
- **Deployment**: Vercel (自動CI/CD)
- **Last Commit**: Step4テンプレートデータ統合・確認システム実装完了 (622d066)
- **分析精度スコア設計**: `ANALYSIS_WEIGHTS.md`で詳細管理
