# Lotsful AI Engine - 段階的情報蓄積型AI分析システム 要件定義書

## プロジェクト概要

企業の業務切り出しを支援し、副業/兼業人材との最適なマッチングを実現するAI分析システム。
**段階的情報蓄積アプローチ**により、各ステップでAI分析を行い、構造化テンプレートに情報を蓄積。
最終的に包括的な5タブ提案書を生成する営業支援ツール。

## 設計思想・開発原則

### システム思考の重視
**全体論的アプローチを基本とする設計方針**

#### 要素還元論ではなく全体論を重視
- ❌ **要素還元的思考**: 「技術的に可能なもの」を積み重ねる部分最適
- ✅ **システム思考**: 営業フロー全体における位置づけから機能を決定

#### 全体設計における重要な判断基準
1. **システム境界の明確化**: 「このシステムでやること vs 他でやること」の明確な線引き
2. **他システムとの関係性**: 営業フロー全体での役割と責任範囲の明確化
3. **本質的価値の追求**: 技術的可能性ではなく、ビジネス価値からの逆算設計
4. **運用現実性の重視**: 理想論ではなく、実際の営業現場での実用性を最優先

#### 具体的適用例
- **1次情報整理システム**: 提案書作成ではなく「情報の化石」整理に特化
- **足し算型データ統合**: AI掛け算分析ではなく、独立した情報の組み合わせ
- **段階的情報蓄積**: 一括処理ではなく、各ステップでの価値創出

### 技術的判断における全体最適
- **複雑性 vs 安定性**: 技術的に高度なソリューションより、運用安定性を重視
- **依存関係の最小化**: エラー波及を防ぐ独立性の確保
- **将来拡張性**: 部分的変更で全体が破綻しない柔軟な設計

## システム構成

- **フロントエンド**: Next.js 15.3.3 + React 19 + TypeScript + Tailwind CSS
- **バックエンド**: Next.js API Routes (サーバーサイド処理)
- **AI**: Google Gemini 2.5 Flash Preview-05-20
- **データ**: セッションベース（データベース不要）
- **デプロイ**: Vercel + GitHub連携

## 機能要件

### 1. 新アーキテクチャ：段階的情報蓄積システム

#### コアコンセプト
**従来**: 一発型AI分析（ステップ3で全情報を一括処理）
**新**: 段階的蓄積型（各ステップでAI分析 → 構造化テンプレートに蓄積 → 最終統合分析）

#### 情報蓄積テンプレート構造
```
lotsful プロジェクト×人材マッチングシート

🏢 会社情報
企業名、業界、設立年、上場状況、従業員数、年商、所在地、事業内容、主要顧客層

🔍 事前リサーチ情報
企業情報メモ（ディープリサーチ結果）、最近の動き、組織特徴、仮説と洞察

📊 現状分析
事業フェーズ、課題カテゴリー、これまでの取り組み、チーム構成、不足スキル、外部人材経験

🎯 プロジェクト設計
解決したい課題、プロジェクトゴール、スコープ、フェーズ分け、稼働イメージ、予算

👤 人材イメージ
役割定義、必要スキル、人物像、カルチャーフィット

🤝 すり合わせ確認事項、💡 マッチング戦略、💭 商談メモ
```

#### 新3ステップフロー
1. **ステップ1: ディープリサーチ入力**
   - リサーチ結果テキスト入力
   - **AI分析ボタン** → 基本企業情報をテンプレートに蓄積
   - 業界自動判定・抽出

2. **ステップ2: 課題・追加情報入力**
   - 構造化入力 or フリーテキスト入力
   - **テンプレート直接編集機能**
   - **AI分析ボタン** → 課題情報をテンプレートに追加蓄積

3. **ステップ3: 業務選択・最終分析**
   - 業界自動連携済み
   - 7×4マトリックスで業務選択
   - 選択内容もテンプレートに保存
   - **最終AI分析** → テンプレート全体から5タブ提案書生成

### 2. 継続機能
- 7×4業務マトリックス（7カテゴリ × 4フェーズ）
- Gemini API統合
- AI Honesty機能（情報不足時は「情報不足により特定不可」表示）

### 3. 新機能：5タブ提案書システム

#### フェーズ1実装（優先度：高）
**Tab 1: 課題整理（自動生成）**
```
現状分析
企業名：[会社名]
業界：[業界]
従業員数：[規模]

課題マッピング
| 領域 | 現状 | 理想 | ギャップ |
|------|------|------|---------|
| [領域1] | [現状詳細] | [理想詳細] | [ギャップ分析] |
| [領域2] | [現状詳細] | [理想詳細] | [ギャップ分析] |
| [領域3] | [現状詳細] | [理想詳細] | [ギャップ分析] |

課題の深掘り
表面的な課題
[表面的に見えている問題]

本質的な課題
[真の原因・構造的な問題]

放置した場合の影響
- 短期（3ヶ月）: [具体的なリスク]
- 中期（6ヶ月）: [具体的なリスク]
- 長期（1年）: [具体的なリスク]
```

**Tab 2: プロジェクト設計（自動生成）**
```
プロジェクト概要
ミッション
[プロジェクトで実現すること]

スコープ定義
含むもの
✅ [スコープ1]
✅ [スコープ2]
✅ [スコープ3]

含まないもの
❌ [対象外1]
❌ [対象外2]

フェーズ設計
Phase 1: [フェーズ名]（[期間]）
目的: [このフェーズのゴール]

主要タスク
- [タスク1]
  詳細：[具体的な作業内容]
  期限：[日数/週数]
- [タスク2]
  詳細：[具体的な作業内容]
  期限：[日数/週数]

成果物
📄 [成果物1]
📊 [成果物2]
🔧 [成果物3]

マイルストーン: [具体的な達成基準]

Phase 2: [フェーズ名]（[期間]）
目的: [このフェーズのゴール]

主要タスク
- [タスク1]
  詳細：[具体的な作業内容]
  期限：[日数/週数]
- [タスク2]
  詳細：[具体的な作業内容]
  期限：[日数/週数]

成果物
📈 [成果物1]
🚀 [成果物2]

マイルストーン: [具体的な達成基準]
```

#### フェーズ2実装（優先度：中）
**Tab 3: 人材提案（手動生成ボタン）**
- 人材要件定義
  - 求める人材像
  - 必要スキルセット
  - 経験レベル
- 人材タイプ提案
  - コンサルタント系
  - 事業会社経験者
  - スタートアップ経験者
  - 専門スキル保有者
- 稼働条件
  - 想定工数（月10-80時間、デフォルト30時間）
  - リモートワーク前提
  - コミュニケーション頻度

**Tab 4: 期待成果（手動生成ボタン）**
- 定量的成果
  - ROI計算
  - コスト削減効果
  - 効率向上指標
- 定性的成果
  - 組織能力向上
  - プロセス改善
  - 競争力強化
- 時系列効果
  - 短期成果（1-3ヶ月）
  - 中期成果（3-6ヶ月）
  - 長期成果（6ヶ月以上）

**Tab 5: 実施要項（手動生成ボタン）**
- 契約形態
  - 準委任契約
  - 成果物ベース契約
  - 時間ベース契約
- 費用構造
  - 時間単価設定
  - 成果物単価
  - 支払い条件
- 実施体制
  - プロジェクト体制図
  - 役割分担
  - 報告ライン

## 技術要件

### データ構造設計

#### 段階的蓄積テンプレート構造
```javascript
{
  // 会社情報
  companyProfile: {
    name: string,
    industry: string[],
    establishedYear: number,
    isPublic: boolean,
    marketListing: string,
    employeeCount: string,
    revenue: string,
    headquarters: string,
    offices: string[],
    businessDescription: string,
    mainCustomers: string
  },
  
  // 事前リサーチ情報
  researchData: {
    deepResearchMemo: string,
    recentNews: string,
    organizationCulture: string,
    hypothesisInsights: string,
    meetingCheckpoints: string[]
  },
  
  // 現状分析
  currentAnalysis: {
    businessPhase: string,
    challengeCategories: string[],
    previousEfforts: string,
    failureReasons: string,
    teamComposition: object[],
    missingSkills: string[],
    externalTalentExperience: string,
    freelanceReadiness: string,
    competitorAnalysis: string,
    decisionProcess: string
  },
  
  // プロジェクト設計
  projectDesign: {
    challengeSummary: string,
    urgencyReason: string,
    risksIfIgnored: string,
    idealState3Months: string,
    successMetrics: object,
    deliverables: string[],
    scope: { included: string[], excluded: string[] },
    phases: object[],
    workingHours: string,
    budget: object
  },
  
  // 人材イメージ
  talentRequirements: {
    expectedRole: string[],
    engagementType: string[],
    requiredSkills: string[],
    preferredSkills: string[],
    industryExperience: object,
    personalityType: string[],
    mindset: string[],
    cultureFit: string
  },
  
  // メタデータ
  metadata: {
    step1Completed: boolean,
    step2Completed: boolean,
    step3Completed: boolean,
    selectedBusinessItems: object[],
    analysisHistory: object[]
  }
}
```

### AI分析エンジン拡張

#### ステップ1: 企業リサーチ分析
```
入力: リサーチテキスト
出力: 企業基本情報 → テンプレート蓄積
分析内容: 企業名、業界、規模、事業内容、特徴抽出
```

#### ステップ2: 課題・追加情報分析
```
入力: 課題情報 + 既存テンプレート
出力: 課題構造化データ → テンプレート追加蓄積
分析内容: 課題分類、優先度、解決アプローチ
```

#### ステップ3: 最終統合分析
```
入力: 完全テンプレート + 選択業務項目
出力: 5タブ提案書
分析内容: 包括的プロジェクト提案生成
```

#### AI Honesty強化プロンプト
```
【重要指示】
- テンプレートに情報がない項目は「情報不足により特定不可」
- 推測や創作は禁止
- 段階的な情報収集の必要性を明示
- 営業現場での実用性を重視
```

### UI/UX設計

#### タブナビゲーション
- 5タブの横スクロール対応
- アクティブタブの視覚的強調
- 生成状態の表示（自動/手動/未生成）

#### 生成ボタン配置
- Tab3-5各タブ内に「AI分析で生成」ボタン
- 生成中のローディング表示
- 生成エラー時の再試行機能

### APIエンドポイント設計

#### 新規API（段階的分析対応）
- `/api/analyze-step1`: 企業リサーチ分析 → テンプレート基本情報蓄積
- `/api/analyze-step2`: 課題・追加情報分析 → テンプレート追加蓄積
- `/api/analyze-step3`: 最終統合分析 → 5タブ提案書生成

#### 既存API拡張
- `/api/analyze`: 既存の一括分析（後方互換）

#### 新規API（手動生成）
- `/api/generate-talent`: Tab3人材提案生成
- `/api/generate-outcome`: Tab4期待成果生成
- `/api/generate-implementation`: Tab5実施要項生成

#### テンプレート管理API
- `/api/template/save`: テンプレート保存
- `/api/template/load`: テンプレート読み込み
- `/api/template/update`: テンプレート部分更新

## 実装計画

### フェーズ1（1-2週間）：段階的蓄積システム基盤
1. **テンプレート構造設計・実装**
   - データ構造定義とTypeScript型定義
   - セッションストレージでのテンプレート管理
   
2. **ステップ1のAI分析機能追加**
   - `/api/analyze-step1` 実装
   - 企業情報抽出・構造化プロンプト開発
   - CompanyInfoInput コンポーネント拡張
   
3. **ステップ2のテンプレート編集機能**
   - テンプレート直接編集UI
   - `/api/analyze-step2` 実装
   
4. **ステップ3の統合分析機能**
   - `/api/analyze-step3` 実装
   - 既存分析エンジンとの統合

### フェーズ2（1週間）：5タブシステム完成
1. **既存5タブ構造の段階的蓄積対応**
2. **Tab3-5手動生成ボタン実装**
3. **エラーハンドリング・UI/UX最適化**
4. **総合テスト・デバッグ**

## 制約事項

- **副業/兼業制約**: リモート中心、月10-80時間（選択可能、デフォルト30時間）、準委任契約
- **AI精度**: 100%正確性不要、営業支援ツールとして十分な品質
- **データ保持**: セッションベース、永続化不要（営業支援用途）
- **対象業界**: 40+業界対応
- **対象業務**: 7カテゴリ×4フェーズ=28分野
- **段階的構築**: 既存システムとの後方互換性維持

## 成功指標

- **段階的蓄積**: 各ステップでテンプレート情報が正確に蓄積される
- **AI分析品質**: 各段階で適切な情報抽出・構造化が行われる
- **ユーザビリティ**: 営業現場で直感的に使える操作性
- **提案品質**: 実際の商談で活用可能なレベルの提案書生成
- **システム安定性**: 段階的分析でのエラー発生時の適切なフォールバック

## 補足事項

- **AI Honesty機能**: 情報不足時の正直な回答（「情報不足により特定不可」）
- **Gemini 2.5 Flash Preview-05-20**: 継続使用
- **段階的リリース**: テンプレート基盤 → ステップ分析 → 5タブ完成
- **既存機能**: 現在の一括分析システムも並行維持

## 開発状況（2025年6月8日現在）

### ✅ フェーズ1完了：段階的情報蓄積システム基盤（2025年6月8日）

#### 🏗️ テンプレート基盤システム
- **TypeScript型定義** (`src/types/template.ts`)
  - 完全な構造化テンプレート定義（CompanyProfile, ResearchData, CurrentAnalysis, ProjectDesign等）
  - 各ステップでの更新対象セクション明確化
  - 初期化関数とバリデーション機能

- **テンプレート管理システム** (`src/utils/templateManager.ts`)
  - セッションストレージでの永続化機能
  - ステップごとの部分更新機能（updateStep1, updateStep2, updateStep3）
  - 深いマージとエラーハンドリング
  - React Hook対応（useTemplate）

#### 🧠 Step1: ディープリサーチ入力・AI分析
- **Step1専用API** (`src/app/api/analyze-step1/route.js`)
  - 企業リサーチテキスト → 構造化データ変換
  - Gemini 2.5 Flash Preview-05-20連携
  - AI Honesty機能（情報不足時は「情報不足により特定不可」）
  - 企業名、業界、従業員数、事業内容等の自動抽出

- **UI拡張** (`src/components/CompanyInfo/CompanyInfoInput.jsx`)
  - AI分析ボタン追加
  - テンプレート自動保存・読み込み
  - 業界自動連携機能
  - 抽出結果の視覚的表示

#### 📝 Step2: テンプレート統合編集・AI補完
- **TemplateEditor UI** (`src/components/TemplateEditor/TemplateEditor.jsx`)
  - 📝 **自由記述・AI自動入力セクション**: 商談議事録等から構造化データに自動変換
  - 🏢 会社情報セクション（Step1結果 + 手動編集）
  - 🔍 リサーチデータセクション（展開・編集可能）
  - 📊 現状分析セクション（新規入力 + AI補完）
  - 🎯 プロジェクト設計セクション（新規入力 + AI補完）
  - セクション展開/折りたたみ、配列項目管理
  - リアルタイム保存・未保存状態表示

- **Step2専用API** (`src/app/api/analyze-step2/route.js`)
  - **自由記述テキスト処理**: 商談議事録・ヒアリング内容をfreeTextパラメータで受信
  - 既存テンプレート情報を活用した補完分析
  - 現状分析とプロジェクト設計の深掘り
  - AI Honesty機能継続
  - 副業/兼業制約を考慮した現実的提案
  - **エラーハンドリング強化**: request.json()重複読み込み問題解決済み

#### 🔄 システム統合
- **ThreeStepFlow統合** (`src/components/ThreeStepFlow/ThreeStepFlow.jsx`)
  - Step2でTemplateEditorを使用
  - テンプレート更新時の業界自動連携
  - 段階的データ蓄積フローの完成
  - 後方互換性維持

#### 🎯 実現した機能フロー
1. **Step1**: リサーチ入力 → AI分析 → 企業情報テンプレート蓄積 ✅
2. **Step2**: 全テンプレート編集 → AI分析 → 深掘り情報補完 ✅
3. **Step3**: 業務選択 → 最終統合分析 → 5タブ提案書生成（実装予定）

### 🔄 実装予定（次回開発時）

#### Step3: 最終統合分析システム
- **業務選択項目のテンプレート連携**
  - 選択した業務項目もテンプレートに保存
  - 既存の7×4マトリックス選択機能の活用

- **最終統合分析API** (`/api/analyze-step3` - 新規作成予定)
  - 完全なテンプレート情報 + 選択業務項目を統合
  - 5タブ提案書の包括的生成
  - 既存の5タブ構造（Tab1: 課題整理, Tab2: プロジェクト設計）との統合

- **5タブ提案書の完全対応**
  - Tab1, Tab2: 自動生成（完了済み）
  - Tab3: 人材提案（手動生成ボタン）
  - Tab4: 期待成果（手動生成ボタン）
  - Tab5: 実施要項（手動生成ボタン）

#### 1次情報統合PDF出力システム
**コンセプト**: AI分析システムの成果物（1次情報）をPDF形式で出力し、営業が他システムで提案書作成時の基礎資料として活用

**データ統合方式**: 足し算型アプローチ
- ❌ 掛け算型（AI全情報考慮）: 複雑、エラーリスク高
- ✅ **足し算型（各パート独立）**: シンプル、安定、確実

**PDF構成**:
```
統合1次情報PDF = ベーステンプレート（Step1+2） + Step3各分析結果

ベーステンプレート（Step1+2完成データ）
├─ 🏢 企業基本情報
├─ 🔍 事前リサーチ情報  
├─ 📊 現状分析
└─ 🎯 プロジェクト設計

Step3分析結果（各々独立してベーステンプレートから生成）
├─ 📋 課題整理（実装済み）
├─ 🔧 プロジェクト設計詳細（実装済み）
├─ 👤 人材提案（未実装）
└─ 💰 期待成果（未実装）
```

**技術仕様**:
- **AI分析データソース統一**: 全Step3分析はベーステンプレート（Step1+2）から実行
- **独立性保証**: 各分析が独立、エラー波及なし、デバッグ容易
- **PDF生成**: react-pdf等でテンプレートデータ + 分析結果を統合レイアウト
- **運用フロー**: システム内で1次情報整理 → PDF出力 → 他システムで提案書作成

**設計判断の根拠**:
- **累積分析 vs ベース分析**: 累積分析（Step3結果を次の分析に使用）は技術的に可能だが、AIトークン制限・依存関係複雑化・エラー波及リスクを考慮してベーステンプレート統一を採用
- **PDF用途の明確化**: 提案書作成ではなく「1次情報（化石）」の整理・出力に特化。加工は他システムで実施
- **情報量 vs 精度**: 1次情報は情報量重視、後の加工で様々な提案書パターンに対応可能

**実装優先度**: Step3完成後（中優先度）

#### 将来拡張（優先度：低）
- Tab3-5の手動生成API実装
- テンプレートエクスポート/インポート機能
- 分析履歴の詳細表示
- 人材マッチング機能（遠い将来の構想）

### 📊 現在のアーキテクチャ状況
```
現在: Step1 ✅ → Step2 ✅ → Step3 🔄 → 5タブ提案書
基盤: テンプレート管理 ✅ + AI分析エンジン ✅ + UI統合 ✅
```

### 🛠️ 技術的成果
- **段階的情報蓄積**による分析精度向上の実現
- **AI Honesty機能**による信頼性の確保
- **セッションベース**の軽量データ管理
- **型安全**なテンプレート操作
- **既存システム**との共存（後方互換性）

### 📝 次回開発時の開始ポイント
1. `src/components/ThreeStepFlow/ThreeStepFlow.jsx`のStep3部分を確認
2. 既存の業務選択機能（BusinessMatrix）とテンプレート連携
3. `/api/analyze-step3`のAPI作成
4. 最終統合分析ロジックの実装
5. 5タブ提案書生成の完成

### 🔧 開発環境・リポジトリ情報
- **Repository**: https://github.com/sassan0808/lotsful-ai-engine-.git
- **Branch**: main
- **Deployment**: Vercel (自動CI/CD)
- **Last Commit**: Step2テンプレート統合編集システム実装完了 (ca876d2)
